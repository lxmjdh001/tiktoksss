{% extends "base.html" %}

{% block title %}代理管理 - {{ title }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- 页面标题 -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="mb-0">
                        <i class="fas fa-users-cog text-primary"></i> 代理管理
                    </h2>
                    <p class="text-muted mb-0">管理代理用户和返佣设置</p>
                </div>
                <div class="d-flex gap-2">
                    <a href="/admin/agents/invite-tree" class="btn btn-outline-primary">
                        <i class="fas fa-sitemap"></i> 邀请树
                    </a>
                    <a href="/admin/agents/commission-records" class="btn btn-outline-success">
                        <i class="fas fa-chart-line"></i> 返佣记录
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- 统计卡片 -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 class="mb-0">{{ total_agents }}</h4>
                            <p class="mb-0">总代理数</p>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-users fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 class="mb-0">{{ active_agents }}</h4>
                            <p class="mb-0">活跃代理</p>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-user-check fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 class="mb-0">{{ agents|selectattr('is_agent', 'equalto', true)|list|length }}</h4>
                            <p class="mb-0">代理等级</p>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-star fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 class="mb-0">¥{{ "%.2f"|format(agents|sum(attribute='total_commission')|float) }}</h4>
                            <p class="mb-0">总返佣</p>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-dollar-sign fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 代理列表 -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-list"></i> 代理列表
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>用户名</th>
                                    <th>邮箱</th>
                                    <th>代理等级</th>
                                    <th>邀请码</th>
                                    <th>直接返佣率</th>
                                    <th>间接返佣率</th>
                                    <th>总返佣</th>
                                    <th>状态</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for agent in agents %}
                                <tr>
                                    <td>{{ agent.id }}</td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="avatar-sm bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-2">
                                                {{ agent.username[0].upper() }}
                                            </div>
                                            {{ agent.username }}
                                        </div>
                                    </td>
                                    <td>{{ agent.email }}</td>
                                    <td>
                                        {% if agent.is_agent %}
                                            <span class="badge bg-success">{{ agent.agent_level }}级代理</span>
                                        {% else %}
                                            <span class="badge bg-secondary">普通用户</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if agent.invite_code %}
                                            <code class="bg-light p-1 rounded">{{ agent.invite_code }}</code>
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ "%.1f"|format(agent.direct_commission_rate * 100) }}%</td>
                                    <td>{{ "%.1f"|format(agent.indirect_commission_rate * 100) }}%</td>
                                    <td>¥{{ "%.2f"|format(agent.total_commission) }}</td>
                                    <td>
                                        {% if agent.status == 1 %}
                                            <span class="badge bg-success">活跃</span>
                                        {% else %}
                                            <span class="badge bg-danger">禁用</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="btn-group" role="group">
                                            {% if not agent.is_agent %}
                                                <button class="btn btn-sm btn-primary" onclick="setAgent({{ agent.id }})">
                                                    <i class="fas fa-user-plus"></i> 设为代理
                                                </button>
                                            {% else %}
                                                <button class="btn btn-sm btn-warning" onclick="updateCommission({{ agent.id }})">
                                                    <i class="fas fa-edit"></i> 修改返佣
                                                </button>
                                            {% endif %}
                                            <button class="btn btn-sm btn-info" onclick="viewInviteTree({{ agent.id }})">
                                                <i class="fas fa-sitemap"></i> 邀请树
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 设为代理模态框 -->
<div class="modal fade" id="setAgentModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-user-plus text-primary"></i> 设为代理
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="setAgentForm">
                <div class="modal-body">
                    <input type="hidden" id="setAgentUserId" name="user_id">
                    
                    <div class="mb-3">
                        <label for="agentLevel" class="form-label">代理等级</label>
                        <select class="form-select" id="agentLevel" name="agent_level" required>
                            <option value="1">1级代理</option>
                            <option value="2">2级代理</option>
                            <option value="3">3级代理</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="directRate" class="form-label">直接返佣率 (%)</label>
                        <input type="number" class="form-control" id="directRate" name="direct_rate" 
                               min="0" max="100" step="0.1" value="10" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="indirectRate" class="form-label">间接返佣率 (%)</label>
                        <input type="number" class="form-control" id="indirectRate" name="indirect_rate" 
                               min="0" max="100" step="0.1" value="5" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> 确认设置
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- 修改返佣模态框 -->
<div class="modal fade" id="updateCommissionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-edit text-warning"></i> 修改返佣比例
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="updateCommissionForm">
                <div class="modal-body">
                    <input type="hidden" id="updateAgentId" name="agent_id">
                    
                    <div class="mb-3">
                        <label for="updateDirectRate" class="form-label">直接返佣率 (%)</label>
                        <input type="number" class="form-control" id="updateDirectRate" name="direct_rate" 
                               min="0" max="100" step="0.1" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="updateIndirectRate" class="form-label">间接返佣率 (%)</label>
                        <input type="number" class="form-control" id="updateIndirectRate" name="indirect_rate" 
                               min="0" max="100" step="0.1" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="submit" class="btn btn-warning">
                        <i class="fas fa-save"></i> 确认修改
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// 设为代理
function setAgent(userId) {
    document.getElementById('setAgentUserId').value = userId;
    new bootstrap.Modal(document.getElementById('setAgentModal')).show();
}

// 修改返佣
function updateCommission(agentId) {
    // 这里需要获取当前代理的返佣比例并填充到表单
    document.getElementById('updateAgentId').value = agentId;
    new bootstrap.Modal(document.getElementById('updateCommissionModal')).show();
}

// 查看邀请树
function viewInviteTree(agentId) {
    window.location.href = `/admin/agents/invite-tree?agent_id=${agentId}`;
}

// 设为代理表单提交
document.getElementById('setAgentForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const data = Object.fromEntries(formData);
    
    try {
        const response = await fetch('/admin/agents/set-agent', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert(`设置成功！邀请码：${result.invite_code}`);
            location.reload();
        } else {
            alert(`设置失败：${result.message}`);
        }
    } catch (error) {
        alert(`请求失败：${error.message}`);
    }
});

// 修改返佣表单提交
document.getElementById('updateCommissionForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    
    try {
        const response = await fetch('/admin/agents/update-commission', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert('修改成功！');
            location.reload();
        } else {
            alert(`修改失败：${result.message}`);
        }
    } catch (error) {
        alert(`请求失败：${error.message}`);
    }
});
</script>

<style>
.avatar-sm {
    width: 32px;
    height: 32px;
    font-size: 14px;
}

.table th {
    border-top: none;
    font-weight: 600;
    color: #495057;
}

.card {
    border: none;
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
}

.card-header {
    background-color: #f8f9fa;
    border-bottom: 1px solid #dee2e6;
}

.btn-group .btn {
    margin-right: 2px;
}

code {
    font-size: 0.875em;
    color: #e83e8c;
}
</style>
{% endblock %}
